#define prt__beam
#include "../prtdirc/src/PrtHit.h"
#include "../prtdirc/src/PrtEvent.h"
#include "prttools.C"
#include <TVirtualFitter.h>
#include <TKey.h>
#include <TRandom.h>

Int_t mcpdata[15][65];
Int_t cluster[15][65];
Int_t lneighbours[65];
Int_t lsize(0);

Int_t getneighbours(Int_t m, Int_t p){
  for(Int_t i=0; i<65; i++) if(p==lneighbours[i]) return -1;
  lneighbours[lsize]=p;
  lsize++;
  for(Int_t t=0; t<65; t++){
    if(mcpdata[m][t]){
      for(Int_t i=0; i<65; i++) if(t==lneighbours[i]) continue;
      if((t==p-1 && p%8!=0) || (t==p+1 && p%8!=7) ||
	 (t==p+8 && p<57) || (t==p-8 && p>8)) getneighbours(m,t);
    }
  }
  return lsize;
}

void getclusters(){
  for(Int_t m=0; m<15; m++){
    for(Int_t p=0; p<65; p++){
      if(mcpdata[m][p])  cluster[m][p] = getneighbours(m,p);
      lsize=0;
      for(Int_t i=0; i<65; i++) lneighbours[i]=0;
    }
  }
}



//void recoPdf(TString path="$HOME/proc/152/beam_15183021251SF.root", TString pdf="$HOME/proc/152/beam_15183021251SF.root", Double_t sigma=1){
//void recoPdf(TString path="$HOME/proc/152/beam_15183013641SF.root", TString pdf="$HOME/proc/152/beam_15183013641SF.root", Double_t sigma=1){
//void recoPdf(TString path="$HOME/proc/152/beam_15183021251SF.root", TString pdf="$HOME/proc/152/beam_15183021251SF.root", Double_t sigma=1){

//void recoPdf(TString path="$HOME/pros/152/beam_15183021251C.root", TString pdf="$HOME/pros/152/beam_15183021251C.root", Double_t sigma=4){
//void recoPdf(TString path="$HOME/pros/152/beam_15183022858C.root", TString pdf="$HOME/pros/152/beam_15183022858C.root", Double_t sigma=2){
//void recoPdf(TString path="$HOME/pros/152/beam_15183015512C.root", TString pdf="$HOME/pros/152/beam_15183015512C.root", Double_t sigma=2){
//void recoPdf(TString path="$HOME/pros/152/beam_15182235455SF.root", TString pdf="$HOME/pros/152/beam_15182235455SF.root", Double_t sigma=2){ //100deg

void recoPdf(TString path="$HOME/pros/170/beam_15179061046C.root", TString pdf="$HOME/pros/170/beam_15179061046C.root", Double_t sigma=2){ //170 2GeV/c
//void recoPdf(TString path="$HOME/pros/170/beam_15179023137C.root", TString pdf="$HOME/pros/170/beam_15179023137C.root", Double_t sigma=2){ //170 3GeV/c

//void recoPdf(TString path="$HOME/pros/170/beam_15179044540C.root", TString pdf="$HOME/pros/170/beam_15179044540C.root", Double_t sigma=2){ //170 7GeV/c
  
  if(path=="") return;
  Int_t studyId;
  TString str = path;
  str.ReplaceAll("jun15","");
  sscanf(str, "%*[^0-9]%d{3}",&studyId);
  fSavePath = Form("data/recopdf_%d",studyId);
  PrtInit(path,1);
  // gStyle->SetOptStat(0);
  CreateMap();
  TGaxis::SetMaxDigits(4);
  
  TCanvas *cc = new TCanvas("cc","cc");
  TH1F *hllf= new TH1F("hllf","hllf;ln L(p) - ln L(#pi); entries [#]",100,-50,50);
  TH1F *hlls= new TH1F("hlls","hlls;ln L(p) - ln L(#pi); entries [#]",100,-50,50);

  TH1F *hl1 = new TH1F("hl1","pdf;LE time [ns]; entries [#]", 1000,0,100);
  TH1F *hl2 = new TH1F("hl2","pdf;LE time [ns]; entries [#]", 1000,0,100);
  TH1F *hl3 = new TH1F("hl3","pdf;LE time [ns]; entries [#]", 1000,0,100);
  
  TH1F *hnph1 = new TH1F("hnph1",";photon yield [#]; entries [#]", 150,0,150);
  TH1F *hnph2 = new TH1F("hnph2",";photon yield [#]; entries [#]", 150,0,150);


  TRandom rand;
  TF1 *pdff[960],*pdfs[960];
  TH1F *hpdff[960],*hpdfs[960];
  if(path.Contains("F.root")) pdf.ReplaceAll("F.root","P.pdf.root");
  
  else  pdf.ReplaceAll(".root",".pdf.root");
  TFile f(pdf);
  
  if(sigma >0) hl3->Rebin((Int_t)sigma);
  Int_t integ1(0), integ2(0);
  for(Int_t i=0; i<960; i++){
    hpdff[i] = (TH1F*)f.Get(Form("hf_%d",i));
    hpdfs[i] = (TH1F*)f.Get(Form("hs_%d",i));
    if(sigma >0) hpdff[i]->Rebin((Int_t)sigma);
    if(sigma >0) hpdfs[i]->Rebin((Int_t)sigma);
    integ1+= hpdff[i]->Integral();
    integ2+= hpdfs[i]->Integral();
    hl3->Add(hpdff[i]);
    hl3->Add(hpdfs[i]);
  }
  if(path.Contains("C.root")) sigma=0;

  TF1 *F1 = new TF1("gaus0","[0]*exp(-0.5*((x-[1])/[2])*(x-[1])/[2])",0,150);
  TF1 *F2 = new TF1("gaus1","[0]*exp(-0.5*((x-[1])/[2])*(x-[1])/[2])",0,150);
  F1->SetParameter(0,1);
  F2->SetParameter(0,1);
      
  F1->SetParameter(1,63);
  F2->SetParameter(1,50);
  F1->SetParameter(2,11);
  F2->SetParameter(2,9);
  
  Double_t theta(0);
  TVirtualFitter *fitter;
  Double_t mom,time,timeres(-1);
  PrtHit fHit;
  Int_t totalf(0),totals(0), ch, entries = 50000; //fCh->GetEntries(); // [50000-rest] - is for pdf generation
  if(path.Contains("F.root")) entries = 10000;
  for (Int_t ievent=0; ievent<entries; ievent++){
    PrtNextEvent(ievent,1000);
    if(ievent==0){
      theta = prt_event->GetAngle();
      mom=prt_event->GetMomentum().Mag();
    }
    
    timeres = prt_event->GetTimeRes();
    Double_t aminf,amins, sum(0),sumf(0),sums(0);
    Int_t nHits =prt_event->GetHitSize();

    if(mom<40 && nHits<30) continue;
    if(prt_event->GetParticle()==2212) hnph1->Fill(nHits);
    if(prt_event->GetParticle()==211 || prt_event->GetParticle()==212) hnph2->Fill(nHits);

    
    // //clusters search
    // for(Int_t h=0; h<nHits; h++) {
    //   Int_t mid=prt_event->GetHit(h).GetMcpId();
    //   Int_t pid=prt_event->GetHit(h).GetPixelId()-1;
    //   mcpdata[mid][pid]=1;
    // }
    // getclusters();

    if(prt_event->GetType()==0){
      // if(fabs(prt_event->GetMomentum().Mag()-7)<0.1){
      // 	if( prt_event->GetParticle()==2212 && prt_event->GetTest1()<175.6 ) continue;
      // 	if( prt_event->GetParticle()==211  && prt_event->GetTest1()>175.1 ) continue;
      // }

      Bool_t tof1(false), tof2(false);
      Bool_t hodo1(false), hodo2(false);
      for(Int_t h=0; h<nHits; h++) {
  	fHit = prt_event->GetHit(h);
  	Int_t gch=fHit.GetChannel();
	
	if(gch>1031 && gch<1034)
	  tof1=true;

	//if(gch>1060)
	   tof2=true;
	
	if(gch>1301 && gch<1305) 
	  hodo1=true;
	// if(gch>1313 && gch<1320)
	  hodo2=true;
	    
	if(tof1 && tof2 && hodo1 && hodo2) goto goodch;
      }

      continue;
    }

  goodch:
    
      
    for(Int_t i=0; i<nHits; i++){
      fHit = prt_event->GetHit(i);
      ch = map_mpc[fHit.GetMcpId()][fHit.GetPixelId()-1];
      time = fHit.GetLeadTime() + rand.Gaus(0,sigma/10.);

      { //time cuts
	Double_t cut1(11);
	if(studyId==157 || studyId==155) cut1=8;
	if(theta<=80){
	  if(time<cut1 || time>45) continue;
	}else if(theta>94){
	  if(time<3 || time>40) continue;
	}
      }
      
      // Int_t mid=fHit.GetMcpId();
      // Int_t pid=fHit.GetPixelId()-1;
      // if(cluster[mid][pid]>6) {
      // 	std::cout<<"cluster[mid][pid]  "<< cluster[mid][pid] <<std::endl;	
      // 	continue;
      // }

      aminf = hpdff[ch]->GetBinContent(hpdff[ch]->FindBin(time)); 
      amins = hpdfs[ch]->GetBinContent(hpdfs[ch]->FindBin(time));   
    
      // if(aminf==0 || amins==0) continue;
      Double_t noise = 1e-3; //1e-7;
      sumf+=TMath::Log((aminf+noise));
      sums+=TMath::Log((amins+noise));    

      if(prt_event->GetParticle()==2212) hl1->Fill(time);
      if(prt_event->GetParticle()==211 || prt_event->GetParticle()==212) hl2->Fill(time);
    }

    sum = sumf-sums;
    if(fabs(sum)<0.1) continue;
    
    // sumf += 10*TMath::Log(F2->Eval(nHits));
    // sums += 10*TMath::Log(F1->Eval(nHits));
    // sum = sumf-sums;
    
    //std::cout<<"sum ===========  "<<sum  << "  "<< sumf<< "  "<< sums<<std::endl;
    
    if(prt_event->GetParticle()==2212) hllf->Fill(sum);
    if(prt_event->GetParticle()==211 || prt_event->GetParticle()==212)  hlls->Fill(sum);

    // for(Int_t j=0; j<15; j++){
    //   for(Int_t i=0; i<65; i++){
    // 	mcpdata[j][i]=0;
    // 	cluster[j][i]=0;
    //   }
    // }
     
  }

  TString name = Form("tis_%d_%1.1f_%1.1f_m%1.1f.root",studyId,theta,sigma,mom);
  if(path.Contains("C.root")) name = Form("tid_%d_%1.1f_%1.1f_m%1.1f.root",studyId,theta,sigma,mom);
  canvasAdd("ll_"+name,800,400);

  prt_normalize(hllf,hlls);
  
  TF1 *ff;
  Double_t m1,m2,s1,s2; 
  if(hllf->GetEntries()>10){
    hllf->Fit("gaus","Sq");
    ff = hllf->GetFunction("gaus");
    m1=ff->GetParameter(1);
    s1=ff->GetParameter(2);
  }
  if(hlls->GetEntries()>10){
    hlls->Fit("gaus","Sq");
    ff = hlls->GetFunction("gaus");
    m2=ff->GetParameter(1);
    s2=ff->GetParameter(2);
  }
  Double_t sep = (fabs(m1-m2))/(0.5*(s1+s2));
  std::cout<<path<<" separation "<< sep <<std::endl;
  hllf->SetTitle(Form("separation = %1.2f",sep));

  
  hllf->SetLineColor(2);
  hllf->Draw();
  hlls->SetLineColor(4);
  hlls->Draw("same");

  hl1->Scale(1/hl1->GetMaximum());
  hl2->Scale(1/hl2->GetMaximum());
  hl3->Scale(1/hl3->GetMaximum());

  prt_normalize(hl1,hl2);
  canvasAdd("hl_"+name,800,500);
  hl1->Draw();
  hl2->SetLineColor(4);
  hl2->Draw("same");
  hl3->SetLineColor(2);
  hl3->Draw("same");

  canvasAdd("hnph_"+name,800,500);
  prt_normalize(hnph1,hnph2);
  hnph1->SetLineColor(4);
  hnph1->Draw();
  hnph2->SetLineColor(2);
  hnph2->Draw("same");

  
  
  canvasSave(1,0);


  TFile fc(fSavePath+"/reco_"+name,"recreate");
  TTree *tc = new TTree("reco","reco");
  tc->Branch("theta",&theta,"theta/D");
  tc->Branch("sep",&sep,"sep/D");
  tc->Branch("sigma",&sigma,"sigma/D");
  tc->Branch("mom",&mom,"mom/D");
  sigma/=10.;
  tc->Fill();
  tc->Write();
}
